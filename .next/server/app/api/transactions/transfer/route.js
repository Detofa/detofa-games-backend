(()=>{var e={};e.id=717,e.ids=[717],e.modules={1693:(e,r,t)=>{"use strict";t.d(r,{W:()=>o});var s=t(43205),n=t.n(s);let a=process.env.JWT_SECRET;function o(e){let r=e.headers.get("authorization");if(!r||!r.startsWith("Bearer "))return null;let t=r.split(" ")[1];try{return n().verify(t,a).userId}catch(e){return console.error("JWT verification failed:",e),null}}},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},27910:e=>{"use strict";e.exports=require("stream")},28354:e=>{"use strict";e.exports=require("util")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},45455:(e,r,t)=>{"use strict";t.d(r,{A:()=>s});let s=new(t(96330)).PrismaClient},55511:e=>{"use strict";e.exports=require("crypto")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},78306:(e,r,t)=>{"use strict";t.r(r),t.d(r,{patchFetch:()=>x,routeModule:()=>p,serverHooks:()=>m,workAsyncStorage:()=>l,workUnitAsyncStorage:()=>f});var s={};t.r(s),t.d(s,{POST:()=>d});var n=t(96559),a=t(48088),o=t(37719),i=t(32190),u=t(45455),c=t(1693);async function d(e){let r=(0,c.W)(e);if(!r)return i.NextResponse.json({error:"Unauthorized"},{status:401});let{toUserPhone:t,amount:s,note:n}=await e.json();if(!t||!s)return i.NextResponse.json({error:"Recipient phone number and amount are required"},{status:400});if(s<=99)return i.NextResponse.json({error:"Amount must be greater than 99"},{status:400});try{let e=await u.A.user.findUnique({where:{phone:t},select:{id:!0,name:!0,phone:!0}});if(!e)return i.NextResponse.json({error:"Recipient not found"},{status:404});if(e.id===r)return i.NextResponse.json({error:"Cannot send funds to yourself"},{status:400});let a=Math.ceil(.03*s),o=s+a,c=await u.A.$transaction(async t=>{let i=await t.user.findUnique({where:{id:r},select:{account:!0}});if(!i)throw Error("Sender not found");if(i.account<o)throw Error("Insufficient funds");return await t.user.update({where:{id:r},data:{account:{decrement:o}}}),await t.user.update({where:{id:e.id},data:{account:{increment:s}}}),await t.transaction.create({data:{fromUserId:r,toUserId:e.id,amount:s,transactionFee:a,note:n||null},include:{fromUser:{select:{id:!0,name:!0,phone:!0}},toUser:{select:{id:!0,name:!0,phone:!0}}}})});return i.NextResponse.json({message:"Transfer completed successfully",transaction:{id:c.id,amount:c.amount,transactionFee:c.transactionFee,totalAmount:c.amount+c.transactionFee,fromUser:c.fromUser,toUser:c.toUser,note:c.note,createdAt:c.createdAt}},{status:200})}catch(e){if(console.error("Transfer error:",e),["Insufficient funds","Sender not found","Recipient not found"].includes(e.message))return i.NextResponse.json({error:e.message},{status:400});return i.NextResponse.json({error:"Internal server error"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/transactions/transfer/route",pathname:"/api/transactions/transfer",filename:"route",bundlePath:"app/api/transactions/transfer/route"},resolvedPagePath:"D:\\Detofa\\Game\\detofa-games-backend\\src\\app\\api\\transactions\\transfer\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:l,workUnitAsyncStorage:f,serverHooks:m}=p;function x(){return(0,o.patchFetch)({workAsyncStorage:l,workUnitAsyncStorage:f})}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},96330:e=>{"use strict";e.exports=require("@prisma/client")},96487:()=>{}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[447,580,205],()=>t(78306));module.exports=s})();